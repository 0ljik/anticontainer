<?xml version="1.0"?>

<project name="anticontainer" default="genupdaterdf">
	
	<target name="clean">
		<delete>
			<fileset dir="." includes="anticontainer.xpi chrome.jar chrome.manifest filters.js"/>
		</delete>
		<delete dir="js"/>
	</target>
	
	<target name="genmanifest">
		<copy file="../chrome.manifest" todir="."/>
		<replace file="chrome.manifest">
			<replacetoken>chrome/</replacetoken>
			<replacevalue>jar:chrome.jar!/</replacevalue>
		</replace>
	</target>
	
	<target name="genfilters">
		<exec executable="c:/python25/python.exe" dir="." osfamily="windows" output="filters.js">
			<arg value="json-to-filters.py" />
		</exec>
		<exec executable="python" osfamily="unix" dir="." output="filters.js">
			<arg value="json-to-filters.py" />
		</exec>
	</target>
	
	<target name="strip">
		<copy todir="./js">
			<fileset dir="../" includes="chrome/** components/** modules/** plugins/**"/>
		</copy>
		<replaceregexp
			flags="s"
			match="/\* \*\*\*\*\*\ BEGIN\ LICENSE\ BLOCK\ \*\*\*\*\*.+\*\*\*\*\*\ END\ LICENSE\ BLOCK\ \*\*\*\*\* \*/"
			replace="&lt;LICENSE&gt;">
			<fileset dir="./js" includes="**/*.js **/*.jsm"/>
		</replaceregexp>
		<replaceregexp
			flags="s"
			match="\*\*\*\*\*\ BEGIN\ LICENSE\ BLOCK\ \*\*\*\*\*.+\*\*\*\*\*\ END\ LICENSE\ BLOCK\ \*\*\*\*\*"
			replace="(C) DownThemAll! - COPYING/SOURCE">
			<fileset dir="./js" includes="**/*.xml **/*.xul"/>
		</replaceregexp>		
		<replaceregexp
			flags="sg"
			match="/\*.*?\*/"
			replace="">
			<fileset dir="./js" includes="**/*.js **/*.jsm"/>
		</replaceregexp>
		<replaceregexp
			flags=""
			byline="true"
			match="^\s*//.*$"
			replace="">
				<fileset dir="./js" includes="**/*.js **/*.jsm"/>
		</replaceregexp>
		<replaceregexp
			flags="s"
			replace="// (C) DownThemAll! - See COPYING/SOURCE"
			match="&lt;LICENSE&gt;">
			<fileset dir="./js" includes="**/*.js **/*.jsm"/>
		</replaceregexp>
		<replaceregexp
			flags="g"
			byline="true"
			match="^\s+|\s+$"
			replace="">
			<fileset dir="./js" includes="**/*.js **/*.jsm **/*.xul **/*.xml **/*.json"/>
		</replaceregexp>				
		<replaceregexp
			flags="sg"
			match="(\r?\n)\r?\n"
			replace="\1">
			<fileset dir="./js" includes="**/*.js **/*.jsm **/*.xul **/*.xml **/*.json"/>
		</replaceregexp>
		<replaceregexp
			flags="sg"
			match="(\r?\n)+"
			replace="">
			<fileset dir="./js" includes="**/*.json"/>
		</replaceregexp>			
	</target>
	
	<target name="chromejar" depends="strip,genmanifest">
		<zip destfile="chrome.jar" compress="false">
			<zipfileset dir="js/chrome" includes="**" />
		</zip>
	</target>
	
	<target name="xpi" depends="clean,strip,chromejar,genmanifest,genfilters">
		<zip destfile="anticontainer.xpi" compress="true" level="9" >
			<zipfileset dir="." includes="chrome.jar chrome.manifest" />
			<zipfileset dir="." includes="filters.js" prefix="defaults/preferences" />
			<zipfileset dir="../defaults/preferences" includes="dtaac.js" prefix="defaults/preferences"/>
			<zipfileset dir="./js/components" includes="*" prefix="components"/>
			<zipfileset dir="./js/modules" includes="*.jsm" prefix="modules"/>
			<zipfileset dir="./js/plugins" includes="*.json" prefix="plugins"/>
			<zipfileset dir=".." includes="install.rdf COPYING SOURCE"/>
		</zip>
	</target>
	
	<target name="genupdaterdf" depends="xpi">
		<exec executable="c:/python25/python.exe" dir="." osfamily="windows">
			<arg value="genhash.py" />
		</exec>
		<exec executable="python" osfamily="unix" dir=".">
			<arg value="genhash.py" />
		</exec>
	</target>

</project>